#!/bin/bash
# Pre-push hook to verify version bump on main/release branches

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get the branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    BRANCH_NAME=$(echo "$remote_ref" | sed 's/refs\/heads\///')

    # Only check main and release branches
    if [[ ! $BRANCH_NAME =~ ^(main|master|release/) ]]; then
        continue
    fi

    echo -e "${YELLOW}üîç Checking version bump for $BRANCH_NAME...${NC}"

    # Get version info from current commit
    if [ -f "app/build.gradle.kts" ]; then
        BUILD_FILE="app/build.gradle.kts"
    elif [ -f "app/build.gradle" ]; then
        BUILD_FILE="app/build.gradle"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No build.gradle file found, skipping version check${NC}"
        continue
    fi

    CURRENT_VERSION_CODE=$(grep -E 'versionCode\s*=\s*[0-9]+' "$BUILD_FILE" | grep -oE '[0-9]+' | head -1)
    CURRENT_VERSION_NAME=$(grep -E 'versionName\s*=\s*["\047][^"\047]+["\047]' "$BUILD_FILE" | grep -oE '["\047][^"\047]+["\047]' | tr -d '"' | tr -d "'" | head -1)

    # Get version from remote (if exists)
    if git rev-parse "origin/$BRANCH_NAME" >/dev/null 2>&1; then
        REMOTE_VERSION_CODE=$(git show "origin/$BRANCH_NAME:$BUILD_FILE" 2>/dev/null | grep -E 'versionCode\s*=\s*[0-9]+' | grep -oE '[0-9]+' | head -1)
        REMOTE_VERSION_NAME=$(git show "origin/$BRANCH_NAME:$BUILD_FILE" 2>/dev/null | grep -E 'versionName\s*=\s*["\047][^"\047]+["\047]' | grep -oE '["\047][^"\047]+["\047]' | tr -d '"' | tr -d "'" | head -1)

        echo "Remote version: $REMOTE_VERSION_NAME ($REMOTE_VERSION_CODE)"
        echo "Local version:  $CURRENT_VERSION_NAME ($CURRENT_VERSION_CODE)"

        # Check if version was bumped
        if [ "$CURRENT_VERSION_CODE" -le "$REMOTE_VERSION_CODE" ]; then
            echo -e "${RED}‚ùå ERROR: versionCode was not incremented!${NC}"
            echo "   Remote: $REMOTE_VERSION_CODE"
            echo "   Local:  $CURRENT_VERSION_CODE"
            echo ""
            echo "Please bump versionCode in $BUILD_FILE"
            exit 1
        fi

        if [ "$CURRENT_VERSION_NAME" == "$REMOTE_VERSION_NAME" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING: versionName was not changed${NC}"
            echo "   Version: $CURRENT_VERSION_NAME"
            echo ""
            read -p "Continue anyway? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                exit 1
            fi
        fi

        echo -e "${GREEN}‚úÖ Version check passed${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No remote branch found, skipping comparison${NC}"
        echo "Current version: $CURRENT_VERSION_NAME ($CURRENT_VERSION_CODE)"
    fi
done

exit 0
