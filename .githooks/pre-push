#!/bin/bash
# Pre-push hook to verify version bump on main/release branches

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get the branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    BRANCH_NAME=$(echo "$remote_ref" | sed 's/refs\/heads\///')

    # Only check main and release branches
    if [[ ! $BRANCH_NAME =~ ^(main|master|release/) ]]; then
        continue
    fi

    echo -e "${YELLOW}üîç Checking version bump for $BRANCH_NAME...${NC}"

    # Get version info from current commit
    if [ -f "app/build.gradle.kts" ]; then
        BUILD_FILE="app/build.gradle.kts"
    elif [ -f "app/build.gradle" ]; then
        BUILD_FILE="app/build.gradle"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No build.gradle file found, skipping version check${NC}"
        continue
    fi

    # FIXED: Extract versionCode and versionName with improved regex
    CURRENT_VERSION_CODE=$(grep -E 'versionCode\s*=\s*[0-9]+' "$BUILD_FILE" | grep -oE '[0-9]+' | head -1)

    # Try double quotes first
    CURRENT_VERSION_NAME=$(grep -E 'versionName\s*=\s*"[^"]+"' "$BUILD_FILE" | grep -oE '"[^"]+"' | tr -d '"' | head -1)

    # Fallback to single quotes if not found
    if [ -z "$CURRENT_VERSION_NAME" ]; then
        CURRENT_VERSION_NAME=$(grep -E "versionName\s*=\s*'[^']+'" "$BUILD_FILE" | grep -oE "'[^']+'" | tr -d "'" | head -1)
    fi

    # Get version from remote (if exists)
    if git rev-parse "origin/$BRANCH_NAME" >/dev/null 2>&1; then
        REMOTE_BUILD_CONTENT=$(git show "origin/$BRANCH_NAME:$BUILD_FILE" 2>/dev/null || echo "")

        if [ -n "$REMOTE_BUILD_CONTENT" ]; then
            # FIXED: Extract remote versions with same improved regex
            REMOTE_VERSION_CODE=$(echo "$REMOTE_BUILD_CONTENT" | grep -E 'versionCode\s*=\s*[0-9]+' | grep -oE '[0-9]+' | head -1)

            # Try double quotes first
            REMOTE_VERSION_NAME=$(echo "$REMOTE_BUILD_CONTENT" | grep -E 'versionName\s*=\s*"[^"]+"' | grep -oE '"[^"]+"' | tr -d '"' | head -1)

            # Fallback to single quotes
            if [ -z "$REMOTE_VERSION_NAME" ]; then
                REMOTE_VERSION_NAME=$(echo "$REMOTE_BUILD_CONTENT" | grep -E "versionName\s*=\s*'[^']+'" | grep -oE "'[^']+'" | tr -d "'" | head -1)
            fi

            echo "Remote version: $REMOTE_VERSION_NAME ($REMOTE_VERSION_CODE)"
            echo "Local version:  $CURRENT_VERSION_NAME ($CURRENT_VERSION_CODE)"
            echo ""

            # Validate extraction
            if [ -z "$CURRENT_VERSION_CODE" ] || [ -z "$REMOTE_VERSION_CODE" ]; then
                echo -e "${RED}‚ùå ERROR: Could not extract version information${NC}"
                echo "Current versionCode: '$CURRENT_VERSION_CODE'"
                echo "Remote versionCode: '$REMOTE_VERSION_CODE'"
                exit 1
            fi

            # Check versionCode
            if [ "$CURRENT_VERSION_CODE" -le "$REMOTE_VERSION_CODE" ]; then
                echo -e "${RED}‚ùå ERROR: versionCode was not incremented!${NC}"
                echo "   Remote: $REMOTE_VERSION_CODE"
                echo "   Local:  $CURRENT_VERSION_CODE"
                echo ""
                echo "Please bump versionCode in $BUILD_FILE"
                echo "Next versionCode should be: $((REMOTE_VERSION_CODE + 1))"
                exit 1
            fi

            CODE_DIFF=$((CURRENT_VERSION_CODE - REMOTE_VERSION_CODE))
            echo -e "${GREEN}‚úÖ versionCode incremented by $CODE_DIFF${NC}"

            # Check versionName
            if [ "$CURRENT_VERSION_NAME" == "$REMOTE_VERSION_NAME" ]; then
                echo -e "${RED}‚ùå ERROR: versionName was not changed!${NC}"
                echo "   Version: $CURRENT_VERSION_NAME"
                echo ""
                echo "Please bump versionName in $BUILD_FILE"

                # Suggest next version based on current
                if [[ $CURRENT_VERSION_NAME =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                    MAJOR="${BASH_REMATCH[1]}"
                    MINOR="${BASH_REMATCH[2]}"
                    PATCH="${BASH_REMATCH[3]}"
                    NEXT_PATCH=$((PATCH + 1))
                    echo "Suggested: $MAJOR.$MINOR.$NEXT_PATCH"
                fi
                exit 1
            fi

            echo -e "${GREEN}‚úÖ versionName updated${NC}"
            echo "   $REMOTE_VERSION_NAME ‚Üí $CURRENT_VERSION_NAME"
            echo ""
            echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
            echo -e "${GREEN}‚úÖ Version check passed${NC}"
            echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Could not read remote build file${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No remote branch found, skipping comparison${NC}"
        echo "Current version: $CURRENT_VERSION_NAME ($CURRENT_VERSION_CODE)"
    fi

    echo ""
done

exit 0
